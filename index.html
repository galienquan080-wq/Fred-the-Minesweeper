<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Underground Echoes</title>

<style>
    body {
        background: #111;
        color: #eee;
        font-family: Arial, sans-serif;
        display: flex;
        gap: 20px;
        padding: 20px;
    }

    #leftPanel, #rightPanel {
        width: 150px;
    }

    #gameBoard {
        display: grid;
        gap: 0;
        background: #000;
    }

    .cell {
        width: 28px;
        height: 28px;
        background: #0a4;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        cursor: pointer;
    }

    .cell-dug {
        background: #835629;
        cursor: default;
    }

    .cell-exploded {
        background: #d00;
        color: #fff;
    }

    #popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #222;
        padding: 20px;
        border: 2px solid #555;
        display: none;
    }

    button {
        padding: 6px 10px;
        margin: 4px;
    }

    button.active {
        background: #0a4;
        color: white;
    }
</style>
</head>

<body>

<div id="leftPanel">
    <h3 id="langTitle">Language</h3>
    <button onclick="setLang('en')">English</button>
    <button onclick="setLang('vi')">Tiáº¿ng Viá»‡t</button>
</div>

<div>
    <h2 id="mainTitle">Underground Echoes</h2>
    <div id="status">Day: 1 | Findings: none</div>

    <div id="gameBoard"></div>
</div>

<div id="rightPanel">
    <h3 id="digModeTitle">Dig Mode</h3>
    <button onclick="setDigMode(1)" class="active">1Ã—1</button>
    <button onclick="setDigMode(3)">3Ã—3</button>
    <button onclick="setDigMode(5)">5Ã—5</button>
</div>

<div id="popup">
    <div id="popupText"></div>
    <button onclick="closePopup()">OK</button>
</div>

<script>
  let day = 1;
  let findings = [];
  let switchCount = 0;
  let currentLang = 'en';
  let currentDigMode = 1;

  const size = Math.floor(Math.random() * 11) + 10;
  const board = [];

  function chooseElement() {
    const r = Math.random();

    if (r < 0.04) return "switch";
    else if (r < 0.10) return "mine";
    else if (r < 0.13) return "fossil";
    else if (r < 0.15) return "treasure";
    return "empty";
  }

  function setupBoard() {
    const boardDiv = document.getElementById("gameBoard");
    boardDiv.style.gridTemplateColumns = `repeat(${size}, 30px)`;
    boardDiv.style.gridTemplateRows = `repeat(${size}, 30px)`;

    let spawnedSwitch = false;

    for (let y = 0; y < size; y++) {
      board[y] = [];
      for (let x = 0; x < size; x++) {
        let element = chooseElement();

        if (element === "switch") {
          if (spawnedSwitch) element = "empty";
          else spawnedSwitch = true;
        }

        const cell = { x, y, element, revealed: false, _div: null };
        board[y][x] = cell;

        const div = document.createElement("div");
        div.classList.add("cell");
        div.onclick = () => reveal(cell);

        cell._div = div;
        boardDiv.appendChild(div);
      }
    }
    
    updateStatus();
  }

  function countMines(x, y) {
    let c = 0;
    for (let dy = -1; dy <= 1; dy++) {
      for (let dx = -1; dx <= 1; dx++) {
        if (dx || dy) {
          const nx = x + dx, ny = y + dy;
          if (board[ny] && board[ny][nx] && board[ny][nx].element === "mine") c++;
        }
      }
    }
    return c;
  }

  function addFinding(type) {
    findings.push(type);
    updateStatus();
  }

  function reveal(cell) {
    if (currentDigMode !== 1) return digArea(cell.x, cell.y, currentDigMode);

    if (cell.revealed) return;
    cell.revealed = true;

    drawCell(cell);

    if (cell.element === "mine") {
      alert(getText("mineHit"));
      location.reload();
    }
  }

  function drawCell(c) {
    const div = c._div;
    div.classList.add("cell-dug");

    switch (c.element) {
      case "mine":
        div.classList.add("cell-exploded");
        div.textContent = "ðŸ’¥";
        break;

      case "switch":
        div.textContent = "ðŸ”§";
        if (confirm(getText("toggleSwitch"))) {
          switchCount++;
          if (switchCount === 666) alert(getText("evilEvent"));
        }
        break;

      case "fossil":
        div.textContent = "ðŸ¦´";
        addFinding("fossil");
        break;

      case "treasure":
        div.textContent = "ðŸ’°";
        addFinding("treasure");
        break;

      default:
        let m = countMines(c.x, c.y);
        div.textContent = m === 0 ? "" : m;
        break;
    }
  }

  function digArea(cx, cy, mode) {
    let r = mode === 3 ? 1 : (mode === 5 ? 2 : 0);

    let triggeredMine = false;

    for (let y = cy - r; y <= cy + r; y++) {
      for (let x = cx - r; x <= cx + r; x++) {
        if (!board[y] || !board[y][x]) continue;

        const c = board[y][x];
        if (c.revealed) continue;

        c.revealed = true;
        drawCell(c);

        if (c.element === "mine") triggeredMine = true;
      }
    }

    if (triggeredMine) {
      alert(getText("mineHit"));
      location.reload();
      return;
    }

    updateStatus();
  }

  function updateStatus() {
    const L = currentLang;
    const txt = L === 'vi'
      ? `NgÃ y: ${day} | PhÃ¡t hiá»‡n: ${findings.length ? findings.join(', ') : 'khÃ´ng cÃ³'}`
      : `Day: ${day} | Findings: ${findings.length ? findings.join(', ') : 'none'}`;
    document.getElementById("status").textContent = txt;
  }

  function setLang(lang) {
    currentLang = lang;
    updateStatus();
  }

  function setDigMode(mode) {
    currentDigMode = mode;
    
    // Update button styles
    document.querySelectorAll('#rightPanel button').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
  }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }

  const TEXT = {
    mineHit: {
      vi: "Fred Ä‘Ã o Ä‘Æ°á»£c má»™t quáº£ mÃ¬n vÃ  bá»‹ ná»• tung! Báº¯t Ä‘áº§u game láº¡i.",
      en: "Fred digs up a mine and gets blown up! Restarting game."
    },
    toggleSwitch: {
      vi: "Gáº¡t cÃ´ng táº¯c? (Coi chá»«ng...)",
      en: "Flip the switch? (Be careful...)"
    },
    evilEvent: {
      vi: "CÃ¡nh cá»•ng háº¯c Ã¡m má»Ÿ ra...",
      en: "The ancient darkness awakens..."
    }
  };

  function getText(key) {
    return TEXT[key][currentLang];
  }

  document.addEventListener("DOMContentLoaded", setupBoard);
</script>

</body>
</html>
